!function(root,factory){if(typeof define==="function"&&define.amd){define(factory)}else{root.Davis=factory()}}(this,function(require){var jQuery=require("jquery");Davis=function(config){var app=new Davis.App;config&&config.call(app);Davis.$(function(){app.start()});return app};if(window.jQuery){Davis.$=jQuery}else{Davis.$=null}Davis.supported=function(){return typeof window.history.pushState=="function"};Davis.noop=function(){};Davis.extend=function(extension){extension(Davis)};Davis.version="0.9.9";Davis.utils=function(){if(Array.prototype.every){var every=function(array,fn){return array.every(fn,arguments[2])}}else{var every=function(array,fn){if(array===void 0||array===null)throw new TypeError;var t=Object(array);var len=t.length>>>0;if(typeof fn!=="function")throw new TypeError;var thisp=arguments[2];for(var i=0;i<len;i++){if(i in t&&!fn.call(thisp,t[i],i,t))return false}return true}}if(Array.prototype.forEach){var forEach=function(array,fn){return array.forEach(fn,arguments[2])}}else{var forEach=function(array,fn){if(array===void 0||array===null)throw new TypeError;var t=Object(array);var len=t.length>>>0;if(typeof fn!=="function")throw new TypeError;var thisp=arguments[2];for(var i=0;i<len;i++){if(i in t)fn.call(thisp,t[i],i,t)}}}if(Array.prototype.filter){var filter=function(array,fn){return array.filter(fn,arguments[2])}}else{var filter=function(array,fn){if(array===void 0||array===null)throw new TypeError;var t=Object(array);var len=t.length>>>0;if(typeof fn!=="function")throw new TypeError;var res=[];var thisp=arguments[2];for(var i=0;i<len;i++){if(i in t){var val=t[i];if(fn.call(thisp,val,i,t))res.push(val)}}return res}}if(Array.prototype.map){var map=function(array,fn){return array.map(fn,arguments[2])}}else{var map=function(array,fn){if(array===void 0||array===null)throw new TypeError;var t=Object(array);var len=t.length>>>0;if(typeof fn!=="function")throw new TypeError;var res=new Array(len);var thisp=arguments[2];for(var i=0;i<len;i++){if(i in t)res[i]=fn.call(thisp,t[i],i,t)}return res}}var toArray=function(args,start){return Array.prototype.slice.call(args,start||0)};return{every:every,forEach:forEach,filter:filter,toArray:toArray,map:map}}();Davis.listener=function(){var originChecks={A:function(elem){return elem.host!==window.location.host||elem.protocol!==window.location.protocol},FORM:function(elem){var a=document.createElement("a");a.href=elem.action;return this.A(a)}};var differentOrigin=function(elem){if(!originChecks[elem.nodeName.toUpperCase()])return true;return originChecks[elem.nodeName.toUpperCase()](elem)};var hasModifier=function(event){return event.altKey||event.ctrlKey||event.metaKey||event.shiftKey};var handler=function(targetExtractor){return function(event){if(hasModifier(event))return true;if(differentOrigin(this))return true;var request=new Davis.Request(targetExtractor.call(Davis.$(this)));Davis.location.assign(request);event.stopPropagation();event.preventDefault();return false}};var clickHandler=handler(function(){var self=this;return{method:"get",fullPath:this.prop("href"),title:this.attr("title"),delegateToServer:function(){window.location=self.prop("href")}}});var submitHandler=handler(function(){var self=this;return{method:this.attr("method"),fullPath:this.serialize()?[this.prop("action"),this.serialize()].join("?"):this.prop("action"),title:this.attr("title"),delegateToServer:function(){self.submit()}}});this.listen=function(){Davis.$(document).delegate(this.settings.formSelector,"submit",submitHandler);Davis.$(document).delegate(this.settings.linkSelector,"click",clickHandler)};this.unlisten=function(){Davis.$(document).undelegate(this.settings.linkSelector,"click",clickHandler);Davis.$(document).undelegate(this.settings.formSelector,"submit",submitHandler)}};Davis.event=function(){var callbacks={};this.bind=function(event,fn){(callbacks[event]=callbacks[event]||[]).push(fn);return this};this.trigger=function(event){var args=Davis.utils.toArray(arguments,1),handlers=callbacks[event];if(!handlers)return this;for(var i=0,len=handlers.length;i<len;++i){handlers[i].apply(this,args)}return this}};Davis.logger=function(){function timestamp(){return"["+Date()+"]"}function prepArgs(args){var a=Davis.utils.toArray(args);a.unshift(timestamp());return a.join(" ")}var logType=function(logLevel){return function(){if(window.console)console[logLevel](prepArgs(arguments))}};var error=logType("error");var info=logType("info");var warn=logType("warn");this.logger={error:error,info:info,warn:warn}};Davis.Route=function(){var pathNameRegex=/:([\w\d]+)/g;var pathNameReplacement="([^/]+)";var splatNameRegex=/\*([\w\d]+)/g;var splatNameReplacement="(.*)";var nameRegex=/[:|\*]([\w\d]+)/g;var Route=function(method,path,handlers){var convertPathToRegExp=function(){if(!(path instanceof RegExp)){var str=path.replace(pathNameRegex,pathNameReplacement).replace(splatNameRegex,splatNameReplacement);path.lastIndex=0;return new RegExp("^"+str+"$","gi")}else{return path}};var convertMethodToRegExp=function(){if(!(method instanceof RegExp)){return new RegExp("^"+method+"$","i")}else{return method}};var capturePathParamNames=function(){var names=[],a;while(a=nameRegex.exec(path))names.push(a[1]);return names};this.paramNames=capturePathParamNames();this.path=convertPathToRegExp();this.method=convertMethodToRegExp();if(typeof handlers==="function"){this.handlers=[handlers]}else{this.handlers=handlers}};Route.prototype.match=function(method,path){this.reset();return this.method.test(method)&&this.path.test(path)};Route.prototype.reset=function(){this.method.lastIndex=0;this.path.lastIndex=0};Route.prototype.run=function(request){this.reset();var matches=this.path.exec(request.path);if(matches){matches.shift();for(var i=0;i<matches.length;i++){request.params[this.paramNames[i]]=matches[i]}}var handlers=Davis.utils.map(this.handlers,function(handler,i){return function(req){return handler.call(req,req,handlers[i+1])}});return handlers[0](request)};Route.prototype.toString=function(){return[this.method,this.path].join(" ")};return Route}();Davis.router=function(){this.route=function(method,path){var createRoute=function(path){var handlers=Davis.utils.toArray(arguments,1),scope=scopePaths.join(""),fullPath,route;typeof path=="string"?fullPath=scope+path:fullPath=path;route=new Davis.Route(method,fullPath,handlers);routeCollection.push(route);return route};return arguments.length==1?createRoute:createRoute.apply(this,Davis.utils.toArray(arguments,1))};this.get=this.route("get");this.post=this.route("post");this.put=this.route("put");this.del=this.route("delete");this.state=this.route("state");this.scope=function(path,fn){scopePaths.push(path);if(arguments.length==1)return;fn.call(this,this);scopePaths.pop()};this.trans=function(path,data){if(data){var fullPath=[path,decodeURIComponent(Davis.$.param(data))].join("?")}else{var fullPath=path}var req=new Davis.Request({method:"state",fullPath:fullPath,title:""});Davis.location.assign(req)};this.filter=function(filterName){return function(){var method=/.+/;if(arguments.length==1){var path=/.+/;var handler=arguments[0]}else if(arguments.length==2){var path=scopePaths.join("")+arguments[0];var handler=arguments[1]}var route=new Davis.Route(method,path,handler);filterCollection[filterName].push(route);return route}};this.lookupFilter=function(filterType){return function(method,path){return Davis.utils.filter(filterCollection[filterType],function(route){return route.match(method,path)})}};this.before=this.filter("before");this.after=this.filter("after");this.lookupBeforeFilter=this.lookupFilter("before");this.lookupAfterFilter=this.lookupFilter("after");var routeCollection=[];var filterCollection={before:[],after:[]};var scopePaths=[];this.lookupRoute=function(method,path){return Davis.utils.filter(routeCollection,function(route){return route.match(method,path)})[0]}};Davis.history=function(){var pushStateHandlers=[];var popped=false;function onPushState(handler){pushStateHandlers.push(handler)}function onPopState(handler){window.addEventListener("popstate",handler,true)}function wrapped(handler){return function(event){if(event.state&&event.state._davis){handler(new Davis.Request(event.state._davis))}else{if(popped)handler(Davis.Request.forPageLoad())}popped=true}}function wrapStateData(data){return{_davis:data}}function onChange(handler){onPushState(handler);onPopState(wrapped(handler))}function changeStateWith(methodName){return function(request,opts){popped=true;history[methodName](wrapStateData(request.toJSON()),request.title,request.location());if(opts&&opts.silent)return;Davis.utils.forEach(pushStateHandlers,function(handler){handler(request)})}}var assign=changeStateWith("pushState");var replace=changeStateWith("replaceState");function current(){return window.location.pathname+(window.location.search?window.location.search:"")}return{onChange:onChange,current:current,assign:assign,replace:replace}}();Davis.location=function(){var locationDelegate=Davis.history;function setLocationDelegate(delegate){locationDelegate=delegate}function current(){return locationDelegate.current()}function sendLocationDelegate(methodName){return function(req,opts){if(typeof req=="string")req=new Davis.Request(req);locationDelegate[methodName](req,opts)}}var assign=sendLocationDelegate("assign");var replace=sendLocationDelegate("replace");function onChange(handler){locationDelegate.onChange(handler)}return{setLocationDelegate:setLocationDelegate,current:current,assign:assign,replace:replace,onChange:onChange}}();Davis.Request=function(){var Request=function(fullPath,opts){if(typeof fullPath=="object"){opts=fullPath;fullPath=opts.fullPath;delete opts.fullPath}var raw=Davis.$.extend({},{title:"",fullPath:fullPath,method:"get",timestamp:+new Date},opts);raw.fullPath=raw.fullPath.replace(/\+/g,"%20");var self=this;this.raw=raw;this.params={};this.title=raw.title;this.queryString=raw.fullPath.split("?")[1];this.timestamp=raw.timestamp;this._staleCallback=function(){};if(this.queryString){Davis.utils.forEach(this.queryString.split("&"),function(keyval){var paramName=decodeURIComponent(keyval.split("=")[0]),paramValue=keyval.split("=")[1],nestedParamRegex=/^(\w+)\[(\w+)?\](\[\])?/,nested;if(nested=nestedParamRegex.exec(paramName)){var paramParent=nested[1];var paramName=nested[2];var isArray=!!nested[3];var parentParams=self.params[paramParent]||{};if(isArray){parentParams[paramName]=parentParams[paramName]||[];parentParams[paramName].push(decodeURIComponent(paramValue));self.params[paramParent]=parentParams}else if(!paramName&&!isArray){parentParams=self.params[paramParent]||[];parentParams.push(decodeURIComponent(paramValue));self.params[paramParent]=parentParams}else{parentParams[paramName]=decodeURIComponent(paramValue);self.params[paramParent]=parentParams}}else{self.params[paramName]=decodeURIComponent(paramValue)}})}raw.fullPath=raw.fullPath.replace(/^https?:\/\/.+?\//,"/");this.method=(this.params._method||raw.method).toLowerCase();this.path=raw.fullPath.replace(/\?(.|[\r\n])+$/,"").replace(/^https?:\/\/[^\/]+/,"");this.fullPath=raw.fullPath;this.delegateToServer=raw.delegateToServer||Davis.noop;this.isForPageLoad=raw.forPageLoad||false;if(Request.prev)Request.prev.makeStale(this);Request.prev=this};Request.prototype.redirect=function(path,opts){Davis.location.replace(new Request({method:"get",fullPath:path,title:this.title}),opts)};Request.prototype.whenStale=function(callback){this._staleCallback=callback};Request.prototype.makeStale=function(req){this._staleCallback.call(req,req)};Request.prototype.location=function(){return this.method==="get"?decodeURI(this.fullPath):""};Request.prototype.toString=function(){return[this.method.toUpperCase(),this.path].join(" ")};Request.prototype.toJSON=function(){return{title:this.raw.title,fullPath:this.raw.fullPath,method:this.raw.method,timestamp:this.raw.timestamp}};Request.forPageLoad=function(){return new this({method:"get",fullPath:Davis.location.current(),title:document.title,forPageLoad:true})};Request.prev=null;return Request}();Davis.App=function(){function App(){this.running=false;this.boundToInternalEvents=false;this.use(Davis.listener);this.use(Davis.event);this.use(Davis.router);this.use(Davis.logger)}App.prototype.configure=function(config){config.call(this.settings,this.settings)};App.prototype.use=function(plugin){plugin.apply(this,Davis.utils.toArray(arguments,1))};App.prototype.helpers=function(helpers){for(property in helpers){if(helpers.hasOwnProperty(property))Davis.Request.prototype[property]=helpers[property]}};App.prototype.settings={linkSelector:"a",formSelector:"form",throwErrors:true,handleRouteNotFound:false,generateRequestOnPageLoad:false};App.prototype.start=function(){var self=this;if(this.running)return;if(!Davis.supported()){this.trigger("unsupported");return}var runFilterWith=function(request){return function(filter){var result=filter.run(request,request);return typeof result==="undefined"||result}};var beforeFiltersPass=function(request){return Davis.utils.every(self.lookupBeforeFilter(request.method,request.path),runFilterWith(request))};var handleRequest=function(request){if(beforeFiltersPass(request)){self.trigger("lookupRoute",request);var route=self.lookupRoute(request.method,request.path);if(route){self.trigger("runRoute",request,route);try{route.run(request);self.trigger("routeComplete",request,route)}catch(error){self.trigger("routeError",request,route,error)}Davis.utils.every(self.lookupAfterFilter(request.method,request.path),runFilterWith(request))}else{self.trigger("routeNotFound",request)}}else{self.trigger("requestHalted",request)}};var bindToInternalEvents=function(){self.bind("runRoute",function(request){self.logger.info("runRoute: "+request.toString())}).bind("routeNotFound",function(request){if(!self.settings.handleRouteNotFound&&!request.isForPageLoad){self.stop();request.delegateToServer()}self.logger.warn("routeNotFound: "+request.toString())}).bind("start",function(){self.logger.info("application started")}).bind("stop",function(){self.logger.info("application stopped")}).bind("routeError",function(request,route,error){if(self.settings.throwErrors)throw error;self.logger.error(error.message,error.stack)});Davis.location.onChange(function(req){handleRequest(req)});self.boundToInternalEvents=true};if(!this.boundToInternalEvents)bindToInternalEvents();this.listen();this.trigger("start");this.running=true;if(this.settings.generateRequestOnPageLoad)handleRequest(Davis.Request.forPageLoad())};App.prototype.stop=function(){this.unlisten();this.trigger("stop");this.running=false};return App}();return Davis});